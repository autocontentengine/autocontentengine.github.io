// Script per il submit reale
document.getElementById('onboarding-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('real-submit-btn');
    const loading = document.getElementById('loading');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';
    loading.style.display = 'block';
    
    try {
        // Raccoglie i dati dal form
        const formData = {
            business_name: document.getElementById('business_name').value,
            content_topics: document.getElementById('content_topics').value,
            website_url: document.getElementById('website_url').value,
            social_media: document.getElementById('social_media').value,
            email: document.getElementById('email').value,
            product_name: 'AI Content Package'
        };
        
        console.log('Sending form data:', formData);
        
        const response = await fetch('/.netlify/functions/create-checkout-with-metadata', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Response received:', data);
        
        if (data.url) {
            window.location.href = data.url;
        } else if (data.sessionId) {
            // Alternative redirect method
            const stripe = Stripe('pk_test_51Qf......'); // Inserisci la tua public key
            await stripe.redirectToCheckout({ sessionId: data.sessionId });
        } else {
            throw new Error('No redirect URL or session ID received');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message + '\n\nCheck console for details.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate My Content Strategy - â‚¬29';
        loading.style.display = 'none';
    }
});
